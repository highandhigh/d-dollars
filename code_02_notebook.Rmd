---
title: "d_dollars Notebook"
output: html_notebook
---
```{r load_librarys}
# remove all from memory -----
library(knitr)
library(rmarkdown)
library(tidyverse)
library(lubridate)
library(stringr)
# library(forcats)
library(modelr)
# library(broom)
library(pander)
library(readxl)
library(NLP)
library(tm)
library(rlist)
library(quantmod) # Financial library

rm(list=ls())

source("code_01_functions.R")
```

Get list of stocks
```{r get_list_of_stocks}
symbols = c('AAPL','GOOG','EMAN')
```

Get the stock data for the stocks that meet the rsi threshold
```{r}
dl2 <- f2_get_stock_data(symbols, days = 120)
head(dl2[[1]])
```

Convert the stocks to a data frame, rename the columns, flatten and nest
```{r nest_stocks_data}
by_stock <- f5_flatten_and_nest_by_stock(dl2)
by_stock
unnest(by_stock, data)
```

Keep only needed data columns and get rsi. filter out na's
```{r get_rsi}
by_stock <- by_stock %>%
  mutate(data = map(data, get_rsi_thresholds)) 
unnest(by_stock, data)
```

Run a scenario given arbatray buy, sell & percent arguments
```{r run_scenario}
by_stock <- by_stock %>%
  mutate(model = map(data, f6_buy_sell_hold_model, buy = 50, sell = 80, 
                     buy_sell_percent = .2))

by_stock$model[[2]]
```

Plot the 'Return on Investment' (roi) for the scenario
```{r scenario_plot_roi, message=FALSE, warning=FALSE}
unnest(by_stock, model) %>%
  ggplot(aes(x = date, y = hold.stock.roi) ) + geom_line(color = "red") + 
  geom_line(aes(y = investing.roi), color = "green") +
  theme(legend.position = "right") +
  facet_grid(stock ~.) + ylab("roi") + ggtitle("blue = hold_cash, red = hold_stock ")

```

Plot total cash value for the scenario
```{r scenario_plot_total_cash}
unnest(by_stock, model) %>%
  ggplot(aes(x = date, y = investing.total)) +  
  geom_line( color = "green") + 
  geom_line(aes(y = cash.only.total),  color = "blue") +
  geom_line(aes(y = hold.stock.total), color = "red") +
  facet_grid(stock ~.) + ylab("total cash + stock in $")  + 
  ggtitle("blue = hold_cash, red = hold_stock, green = investing")
```
MULTIPLE SCENARIO's
Create a grid of scenario arguments so we can find the max roi
```{r grid_scenario_arg}
buy  <- 
  seq(10, 50, length.out = 4) %>%
  as.integer()

sell <- seq(50, 90, length.out = 4) %>%
  as.integer()

buy_sell_percent <- 
  seq(.1, .5, length.out = 4) %>%
  round(digits = 2)

args1 <- expand.grid(dl = by_stock$data, buy = buy, sell = sell, 
                     buy_sell_percent = buy_sell_percent)

args1
```



```{r}



models <- pmap( args1, f6_buy_sell_hold_model)

# by_stock <- by_stock %>%
#   mutate(model_grid = pmap(data, ... = buy, sell, buy_sell_percent, 
#                            .f = f6_buy_sell_hold_model))
# str(by_stock)
# str(dat)
# dat


```


```{r}


models2[[1]]
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
